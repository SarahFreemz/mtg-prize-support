<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>MTG Prize Support Calculator</title>
        <!-- Bootstrap 5 CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet" />
    </head>
    <body class="container-fluid bg-light">
        <div class="container px-2 px-sm-4 py-4" style="max-width: 600px; margin-top: 40px;">
  <div class="d-flex align-items-center mb-3">
    <a href="/" class="btn btn-sm btn-outline-secondary me-3">&larr; Home</a>
    <h3 class="mb-0 flex-grow-1 text-center">Prize Support Calculator</h3>
    <div style="width:86px;"></div>
  </div>

            <p class="text-center text-muted">
                Enter the names and prices of the prize packs available. The total number
                of packs available for prizing will be calculated automatically.
            </p>
            
            <!-- Configuration Section -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Configuration Settings</small>
                    <button class="btn btn-link p-0 text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#configSection" aria-expanded="false" aria-controls="configSection" style="font-size: 14px;">
                        <svg width="14" height="14" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
                            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                            <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                        </svg>
                    </button>
                </div>
                <div class="collapse" id="configSection">
                    <div class="p-3 bg-white rounded border">
                        <div class="row g-2 mb-3">
                            <div class="col-6 col-md-6">
                                <label for="storeProfitRate" class="form-label small text-muted">Store Profit Rate (%)</label>
                                <input
                                    type="number"
                                    id="storeProfitRate"
                                    name="storeProfitRate"
                                    class="form-control form-control-sm"
                                    value="20"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                            <div class="col-6 col-md-6">
                                <label for="toPayoutRate" class="form-label small text-muted">TO Payout Rate (%)</label>
                                <input
                                    type="number"
                                    id="toPayoutRate"
                                    name="toPayoutRate"
                                    class="form-control form-control-sm"
                                    value="20"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6 col-md-6">
                                <label for="storeCostFactor" class="form-label small text-muted">Store Cost Factor (%)</label>
                                <input
                                    type="number"
                                    id="storeCostFactor"
                                    name="storeCostFactor"
                                    class="form-control form-control-sm"
                                    value="60"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                            <div class="col-6 col-md-6">
                                <label for="salesTaxRate" class="form-label small text-muted">Sales Tax Rate (%)</label>
                                <input
                                    type="number"
                                    id="salesTaxRate"
                                    name="salesTaxRate"
                                    class="form-control form-control-sm"
                                    value="6"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <form id="prizeForm">
                <div class="row g-2 mb-3">
                    <div class="col-6 col-md-6">
                        <label for="numPlayers" class="form-label">Number of Players</label>
                        <input
                            type="number"
                            id="numPlayers"
                            name="numPlayers"
                            class="form-control"
                            min="1"
                            required />
                    </div>
                    <div class="col-6 col-md-6">
                        <label for="entryFee" class="form-label">Entry Fee</label>
                        <input
                            type="number"
                            id="entryFee"
                            name="entryFee"
                            class="form-control"
                            min="0"
                            step="any"
                            required />
                    </div>
                </div>
                <div class="mb-3 row g-2 align-items-center">
                    <div class="col-auto">
                        <div class="form-check">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                id="withTO"
                                name="withTO" />
                            <label class="form-check-label" for="withTO">With TO</label>
                        </div>
                    </div>
                </div>

                <!-- Event Packs (per-entry) - optional -->
                <h5 class="small text-muted">Event Packs (per-entry, optional)</h5>
                <div id="eventEntries">
                    <div class="event-entry-row row mb-2 g-1 align-items-center">
                        <div class="col-6 col-md-6">
                            <label class="form-label visually-hidden">Pack Name</label>
                            <input type="text" name="eventPackName" class="form-control" placeholder="Name" />
                        </div>
                        <div class="col-4 col-md-4">
                            <label class="form-label visually-hidden">Price/Pack</label>
                            <input type="number" name="eventPrice" class="form-control" placeholder="Price" step="any" />
                        </div>
                        <div class="col-2 col-md-2">
                            <label class="form-label visually-hidden">Qty/Entry</label>
                            <input type="number" name="eventQtyPerEntry" class="form-control" placeholder="Qty" min="0" step="1" value="0" />
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addEventEntry()">Add Event Pack</button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLastEventEntry()">Remove Event Pack</button>
                </div>

                <hr />

                <!-- Prize Packs section -->
                <div id="entries">
                    <div class="entry-row row mb-2 g-1 align-items-center">
                        <div class="col-6 col-md-6">
                            <label for="packName" class="form-label">Pack Name</label>
                            <input
                                type="text"
                                name="packName"
                                class="form-control"
                                placeholder="Name"
                                required />
                        </div>
                        <div class="col-6 col-md-6">
                            <label for="price" class="form-label">Price/Pack</label>
                            <input
                                type="number"
                                name="price"
                                class="form-control"
                                placeholder="Price"
                                step="any"
                                required />
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addEntry()">
                        Add Another
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLastEntry()">
                        Remove Last
                    </button>
                </div>

                                                <!-- Additional costs (hidden by default; click to add) -->
                                                <div class="row mb-3">
                                                    <div class="col-12 d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <!-- Button moved to the left; helper text visible by default for non-JS users -->
                                                                    <button type="button" id="addAdditionalCostsBtn" class="btn btn-outline-secondary btn-sm" style="display:none">Add additional costs</button>
                                                                    <div id="additionalCostsText" style="margin-left:8px;">
                                                                        <small class="text-muted">Additional costs (optional)</small>
                                                                        <div class="form-text small text-muted">Other event expenses to deduct from revenue (paid event kit, judge, etc.)</div>
                                                                    </div>
                                                                </div>
                                                                    <div class="d-flex align-items-center gap-2">
                                                                    <div id="additionalCostsWrapper">
                                                                        <div class="input-group input-group-sm">
                                                                            <input type="number" id="additionalCosts" name="additionalCosts" class="form-control" value="0" min="0" step="any" style="max-width:140px;" />
                                                                            <button type="button" id="removeAdditionalCostsBtn" class="btn btn-outline-danger">Remove</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                    </div>
                                                </div>
                
                <button type="submit" class="btn btn-primary w-100">Calculate Prize Distribution</button>
            </form>
            
            <div id="result" class="mt-4"></div>
            <div class="mt-2">
                <button id="printReceiptBtn" class="btn btn-outline-secondary btn-sm" style="display:none">Print receipt</button>
            </div>
        </div>
        
        <!-- Bootstrap 5 JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Event pack functions (per-entry)
                function addEventEntry() {
                    const div = document.createElement('div');
                    div.className = 'event-entry-row row mb-2 g-1 align-items-center';
                    div.innerHTML =
                        '<div class="col-6 col-md-6">' +
                            '<label class="form-label visually-hidden">Pack Name</label>' +
                            '<input type="text" name="eventPackName" class="form-control" placeholder="Name">' +
                        '</div>' +
                        '<div class="col-4 col-md-4">' +
                            '<label class="form-label visually-hidden">Price/Pack</label>' +
                            '<input type="number" name="eventPrice" class="form-control" placeholder="Price" step="any">' +
                        '</div>' +
                        '<div class="col-2 col-md-2">' +
                            '<label class="form-label visually-hidden">Qty/Entry</label>' +
                            '<input type="number" name="eventQtyPerEntry" class="form-control" placeholder="Qty" min="0" step="1" value="0">' +
                        '</div>';
                    document.getElementById('eventEntries').appendChild(div);
                }

                function removeLastEventEntry() {
                    const entries = document.getElementById('eventEntries');
                    if (entries.children.length > 1) entries.removeChild(entries.lastElementChild);
                }

                function addEntry() {
                    var div = document.createElement('div');
                    div.className = 'entry-row row g-1 mb-2 align-items-center';

                    div.innerHTML =
                        '<div class="col-6 col-md-6">' +
                            '<label class="form-label visually-hidden">Pack Name</label>' +
                            '<input type="text" name="packName" class="form-control" placeholder="Name" required>' +
                        '</div>' +
                        '<div class="col-6 col-md-6">' +
                            '<label class="form-label visually-hidden">Price/Pack</label>' +
                            '<input type="number" name="price" class="form-control" placeholder="Price" step="any" required>' +
                        '</div>';

                    document.getElementById('entries').appendChild(div);
                }

                function removeLastEntry() {
                    var entries = document.getElementById('entries');
                    if (entries.children.length > 1) {
                        entries.removeChild(entries.lastElementChild);
                    }
                }

                // Expose helpers used by inline buttons
                window.addEventEntry = addEventEntry;
                window.removeLastEventEntry = removeLastEventEntry;
                window.addEntry = addEntry;
                window.removeLastEntry = removeLastEntry;

                // Utility to escape HTML when injecting server strings into the page
                function escapeHtml(str) {
                    return String(str || '')
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                }

                const prizeForm = document.getElementById('prizeForm');
                if (prizeForm) {
                    prizeForm.onsubmit = async function (e) {
                        e.preventDefault();
                        
                        const formData = new FormData(this);
                        const packNames = [];
                        const prices = [];
                        
                        document.querySelectorAll('input[name="packName"]').forEach((input) => packNames.push(input.value));
                        document.querySelectorAll('input[name="price"]').forEach((input) => prices.push(input.value));

                        // Collect event packs (optional)
                        const eventNames = Array.from(document.querySelectorAll('input[name="eventPackName"]')).map(i => i.value);
                        const eventPrices = Array.from(document.querySelectorAll('input[name="eventPrice"]')).map(i => i.value);
                        const eventQtys = Array.from(document.querySelectorAll('input[name="eventQtyPerEntry"]')).map(i => i.value);

                        const eventPacks = eventNames.map((name, idx) => ({
                            name,
                            price: eventPrices[idx],
                            qtyPerPlayer: parseInt(eventQtys[idx], 10) || 0
                        })).filter(p => p.name || parseFloat(p.price) > 0 || p.qtyPerPlayer > 0); // drop empty rows

                        // Get configuration values
                        const config = {
                            storeProfitRate: parseFloat(document.getElementById('storeProfitRate').value) / 100,
                            toPayoutRate: parseFloat(document.getElementById('toPayoutRate').value) / 100,
                            storeCostFactor: parseFloat(document.getElementById('storeCostFactor').value) / 100,
                            salesTaxRate: parseFloat(document.getElementById('salesTaxRate').value) / 100
                        };

                        // Additional costs (optional)
                        const additionalCosts = parseFloat(formData.get('additionalCosts')) || 0;

                        const data = {
                            numPlayers: parseInt(formData.get('numPlayers')),
                            entryFee: parseFloat(formData.get('entryFee')),
                            withTO: formData.get('withTO') === 'on',
                            config: config,
                            packs: packNames.map((name, i) => ({ name, price: prices[i] })),
                            eventPacks: eventPacks,
                            additionalCosts: additionalCosts,
                            mode: 'prize' // set per page: 'prize' | 'to-payout' | 'entry-fee'
                        };

                        try {
                            const response = await fetch('/process', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data),
                            });

                            const result = await response.json();

                            // Build a clearer UI using structured JSON when available
                            let out = '<div class="alert alert-success">';
                            // Remaining prize pool
                            if (result.totals && typeof result.totals.prizePool === 'number') {
                                out += `<div><strong>Remaining prize pool:</strong> $${result.totals.prizePool.toFixed(2)}</div>`;
                            }

                            // Allocatable packs table (if present)
                            if (result.totals && Array.isArray(result.totals.allocatablePacks) && result.totals.allocatablePacks.length > 0) {
                                out += '<div class="mt-2"><small class="text-muted">Packs available (whole packs):</small>';
                                out += '<table class="table table-sm table-striped mt-2"><thead><tr><th>Pack</th><th>Quantity</th></tr></thead><tbody>';
                                result.totals.allocatablePacks.forEach(p => {
                                    out += `<tr><td>${escapeHtml(p.name)}</td><td>${p.purchasable}</td></tr>`;
                                });
                                out += '</tbody></table></div>';
                            }

                            // Fallback: include the server's human-readable summary in a collapsed pre block
                            if (result.result) {
                                out += `<details class="mt-2"><summary>Detailed summary</summary><pre style="white-space:pre-wrap;">${escapeHtml(result.result)}</pre></details>`;
                            }

                            out += '</div>';
                            document.getElementById('result').innerHTML = out;
                            // Build a plain-text receipt for printing and enable the print button
                            window.__lastReceiptText = buildReceiptText(result);
                            const prBtn = document.getElementById('printReceiptBtn');
                            if (window.__lastReceiptText && prBtn) {
                                prBtn.style.display = 'inline-block';
                            } else if (prBtn) {
                                prBtn.style.display = 'none';
                            }
                        } catch (error) {
                            document.getElementById('result').innerHTML = `<div class="alert alert-danger">Error: ${escapeHtml(error.message)}</div>`;
                        }
                    };
                }

                // Utility: build plain-text receipt
                function buildReceiptText(result) {
                    if (!result || !result.totals) return '';
                    const lines = [];
                    lines.push('MTG Prize Support');
                    lines.push('------------------------------');
                    lines.push(`Mode: ${result.mode || ''}`);
                    if (typeof result.totals.totalEntryFee === 'number') lines.push(`Total revenue: $${result.totals.totalEntryFee.toFixed(2)}`);
                    if (typeof result.totals.totalEntryFeeMinusTax === 'number') lines.push(`Revenue after tax: $${result.totals.totalEntryFeeMinusTax.toFixed(2)}`);
                    if (typeof result.totals.storeProfit === 'number') lines.push(`Store profit: $${result.totals.storeProfit.toFixed(2)}`);
                    if (typeof result.totals.toPayout === 'number' && result.totals.toPayout > 0) lines.push(`TO payout: $${result.totals.toPayout.toFixed(2)}`);
                    if (typeof result.totals.additionalCosts === 'number') lines.push(`Additional costs: $${result.totals.additionalCosts.toFixed(2)}`);
                    lines.push('');
                    if (typeof result.totals.prizePool === 'number') lines.push(`Remaining prize pool: $${result.totals.prizePool.toFixed(2)}`);
                    lines.push('');
                    if (Array.isArray(result.totals.allocatablePacks) && result.totals.allocatablePacks.length > 0) {
                        lines.push('Packs purchasable:');
                        result.totals.allocatablePacks.forEach(p => {
                            lines.push(`${p.name}  x ${p.purchasable}`);
                        });
                    }
                    lines.push('');
                    lines.push('Thank you');
                    return lines.join('\n');
                }

                // Print button handler: open a small window with monospaced receipt text and call print()
                const prBtn = document.getElementById('printReceiptBtn');
                if (prBtn) {
                    prBtn.addEventListener('click', function () {
                        const text = window.__lastReceiptText || '';
                        const w = window.open('', 'receipt', 'width=320,height=600');
                        if (!w) return alert('Popup blocked — allow popups for this site to print receipts.');
                        const html = `<!doctype html><html><head><title>Receipt</title><meta charset="utf-8"><style>body{font-family:monospace;white-space:pre-wrap;padding:8px} .receipt{width:280px;}</style></head><body><div class="receipt"><pre>${escapeHtml(text)}</pre></div><script>window.onload=function(){window.print();setTimeout(()=>window.close(),200);}</script></body></html>`;
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                    });
                }
            });
        </script>
        <script src="/additional-costs.js"></script>
    </body>
</html>

