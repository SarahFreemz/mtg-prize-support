<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>MTG Prize Support Calculator</title>
        <!-- Bootstrap 5 CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet" />
    </head>
    <body class="container-fluid bg-light">
        <div class="container px-2 px-sm-4 py-4" style="max-width: 600px; margin-top: 40px;">
            <h3 class="mb-3 text-center">Prize Support Calculator</h3>
            <p class="text-center text-muted">
                Enter the names and prices of the prize packs available. The total number
                of packs available for prizing will be calculated automatically.
            </p>
            
            <!-- Configuration Section -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Configuration Settings</small>
                    <button class="btn btn-link p-0 text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#configSection" aria-expanded="false" aria-controls="configSection" style="font-size: 14px;">
                        <svg width="14" height="14" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
                            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                            <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                        </svg>
                    </button>
                </div>
                <div class="collapse" id="configSection">
                    <div class="p-3 bg-white rounded border">
                        <div class="row g-2 mb-3">
                            <div class="col-6 col-md-6">
                                <label for="storeProfitRate" class="form-label small text-muted">Store Profit Rate (%)</label>
                                <input
                                    type="number"
                                    id="storeProfitRate"
                                    name="storeProfitRate"
                                    class="form-control form-control-sm"
                                    value="20"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                            <div class="col-6 col-md-6">
                                <label for="toPayoutRate" class="form-label small text-muted">TO Payout Rate (%)</label>
                                <input
                                    type="number"
                                    id="toPayoutRate"
                                    name="toPayoutRate"
                                    class="form-control form-control-sm"
                                    value="20"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6 col-md-6">
                                <label for="storeCostFactor" class="form-label small text-muted">Store Cost Factor (%)</label>
                                <input
                                    type="number"
                                    id="storeCostFactor"
                                    name="storeCostFactor"
                                    class="form-control form-control-sm"
                                    value="60"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                            <div class="col-6 col-md-6">
                                <label for="salesTaxRate" class="form-label small text-muted">Sales Tax Rate (%)</label>
                                <input
                                    type="number"
                                    id="salesTaxRate"
                                    name="salesTaxRate"
                                    class="form-control form-control-sm"
                                    value="6"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <form id="prizeForm">
                <div class="row g-2 mb-3">
                    <div class="col-6 col-md-6">
                        <label for="numPlayers" class="form-label">Number of Players</label>
                        <input
                            type="number"
                            id="numPlayers"
                            name="numPlayers"
                            class="form-control"
                            min="1"
                            required />
                    </div>
                    <div class="col-6 col-md-6">
                        <label for="entryFee" class="form-label">Entry Fee</label>
                        <input
                            type="number"
                            id="entryFee"
                            name="entryFee"
                            class="form-control"
                            min="0"
                            step="any"
                            required />
                    </div>
                </div>
                <div class="mb-3 row g-2 align-items-center">
                    <div class="col-auto">
                        <div class="form-check">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                id="withTO"
                                name="withTO" />
                            <label class="form-check-label" for="withTO">With TO</label>
                        </div>
                    </div>
                </div>
                
                <div id="entries">
                    <div class="entry-row row mb-2 g-1 align-items-center">
                        <div class="col-6 col-md-6">
                            <label for="packName" class="form-label">Pack Name</label>
                            <input
                                type="text"
                                name="packName"
                                class="form-control"
                                placeholder="Name"
                                required />
                        </div>
                        <div class="col-6 col-md-6">
                            <label for="price" class="form-label">Price/Pack</label>
                            <input
                                type="number"
                                name="price"
                                class="form-control"
                                placeholder="Price"
                                step="any"
                                required />
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addEntry()">
                        Add Another
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLastEntry()">
                        Remove Last
                    </button>
                </div>
                
                <button type="submit" class="btn btn-primary w-100">Calculate Prize Distribution</button>
            </form>
            
            <div id="result" class="mt-4"></div>
        </div>
        
        <!-- Bootstrap 5 JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            function addEntry() {
                var div = document.createElement('div');
                div.className = 'entry-row row g-1 mb-2 align-items-center';

                div.innerHTML =
                    '<div class="col-6 col-md-6">' +
                        '<label class="form-label visually-hidden">Pack Name</label>' +
                        '<input type="text" name="packName" class="form-control" placeholder="Name" required>' +
                    '</div>' +
                    '<div class="col-6 col-md-6">' +
                        '<label class="form-label visually-hidden">Price/Pack</label>' +
                        '<input type="number" name="price" class="form-control" placeholder="Price" step="any" required>' +
                    '</div>';

                document.getElementById('entries').appendChild(div);
            }

            function removeLastEntry() {
                var entries = document.getElementById('entries');
                if (entries.children.length > 1) {
                    entries.removeChild(entries.lastElementChild);
                }
            }

            document.getElementById('prizeForm').onsubmit = async function (e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const packNames = [];
                const prices = [];
                
                document.querySelectorAll('input[name="packName"]').forEach((input) => packNames.push(input.value));
                document.querySelectorAll('input[name="price"]').forEach((input) => prices.push(input.value));

                // Get configuration values
                const config = {
                    storeProfitRate: parseFloat(document.getElementById('storeProfitRate').value) / 100,
                    toPayoutRate: parseFloat(document.getElementById('toPayoutRate').value) / 100,
                    storeCostFactor: parseFloat(document.getElementById('storeCostFactor').value) / 100,
                    salesTaxRate: parseFloat(document.getElementById('salesTaxRate').value) / 100
                };

                const data = {
                    numPlayers: parseInt(formData.get('numPlayers')),
                    entryFee: parseFloat(formData.get('entryFee')),
                    withTO: formData.get('withTO') === 'on',
                    config: config,
                    packs: packNames.map((name, i) => ({
                        name,
                        price: prices[i],
                    })),
                };

                try {
                    const response = await fetch('/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                    
                    const result = await response.json();
                    document.getElementById('result').innerHTML = `<div class="alert alert-success"><pre>${result.result}</pre></div>`;
                } catch (error) {
                    document.getElementById('result').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                }
            };
        </script>
    </body>
</html>
