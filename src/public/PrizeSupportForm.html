<!doctype html>
<html>
    <head>
        <base target="_top" />
        <!-- Bootstrap 5 CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet" />
    </head>
    <body class="container-fluid bg-light">
        <div class="container px-2 px-sm-4 py-4" style="max-width: 600px; margin-top: 40px;">
            <h3 class="mb-3 text-center">Prize Support Calculator</h3>
            <p class="text-center">
                Enter the names and prices of the prize packs available. The total number
                of packs available for prizing will be calculated automatically.
            </p>
            
            <!-- Configuration Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <button class="btn btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#configSection">
                        <strong>Configuration Settings</strong> (Click to expand)
                    </button>
                </div>
                <div class="collapse" id="configSection">
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-6 col-md-6">
                                <label for="storeProfitRate" class="form-label">Store Profit Rate (%)</label>
                                <input
                                    type="number"
                                    id="storeProfitRate"
                                    name="storeProfitRate"
                                    class="form-control"
                                    value="20"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                            <div class="col-6 col-md-6">
                                <label for="toPayout" class="form-label">TO Payout Rate (%)</label>
                                <input
                                    type="number"
                                    id="toPayoutRate"
                                    name="toPayoutRate"
                                    class="form-control"
                                    value="20"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6 col-md-6">
                                <label for="storeCostFactor" class="form-label">Store Cost Factor (%)</label>
                                <input
                                    type="number"
                                    id="storeCostFactor"
                                    name="storeCostFactor"
                                    class="form-control"
                                    value="60"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                            <div class="col-6 col-md-6">
                                <label for="salesTaxRate" class="form-label">Sales Tax Rate (%)</label>
                                <input
                                    type="number"
                                    id="salesTaxRate"
                                    name="salesTaxRate"
                                    class="form-control"
                                    value="6"
                                    min="0"
                                    max="100"
                                    step="any" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <form id="prizeForm">
                <div class="row g-2 mb-3">
                    <div class="col-6 col-md-6">
                        <label for="numPlayers" class="form-label">Number of Players</label>
                        <input
                            type="number"
                            id="numPlayers"
                            name="numPlayers"
                            class="form-control"
                            min="1"
                            required />
                    </div>
                    <div class="col-6 col-md-6">
                        <label for="entryFee" class="form-label">Entry Fee</label>
                        <input
                            type="number"
                            id="entryFee"
                            name="entryFee"
                            class="form-control"
                            min="0"
                            step="any"
                            required />
                    </div>
                </div>
                <div class="mb-3 row g-2 align-items-center">
                    <div class="col-auto mt-4">
                        <div class="form-check">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                id="withTO"
                                name="withTO" />
                            <label class="form-check-label" for="withTO">With TO</label>
                        </div>
                    </div>
                </div>
                <div id="entries">
                    <div class="entry-row row mb-2 g-1 align-items-center justify-content-center">
                        <div class="col-6 col-md-6">
                            <label for="packName" class="form-label">Pack Name</label>
                            <input
                                type="text"
                                name="packName"
                                class="form-control"
                                placeholder="Name"
                                required />
                        </div>
                        <div class="col-6 col-md-6">
                            <label for="price" class="form-label">Price/Pack</label>
                            <input
                                type="number"
                                name="price"
                                class="form-control"
                                placeholder="Price"
                                step="any"
                                required />
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary mt-2" onclick="addEntry()">
                    Add Another
                </button>
                <button
                    type="button"
                    class="btn btn-danger mt-2"
                    onclick="removeLastEntry()">
                    Remove Last
                </button>
                <br /><br />
                <input type="submit" class="btn btn-primary" value="Submit" />
            </form>
            <div id="result"></div>
        </div>
        <!-- Bootstrap 5 JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            function addEntry() {
                var div = document.createElement('div');
                div.className = 'entry-row row g-1 mb-2 align-items-center justify-content-center';

                div.innerHTML =
                    '<div class="col-6 col-md-6">' +
                        '<label class="form-label visually-hidden">Pack Name</label>' +
                        '<input type="text" name="packName" class="form-control" placeholder="Name" required>' +
                    '</div>' +
                    '<div class="col-6 col-md-6">' +
                        '<label class="form-label visually-hidden">Price/Pack</label>' +
                        '<input type="number" name="price" class="form-control" placeholder="Price" step="any" required>' +
                    '</div>';

                document.getElementById('entries').appendChild(div);
            }

            function removeLastEntry() {
                var entries = document.getElementById('entries');
                if (entries.children.length > 1) {
                    entries.removeChild(entries.lastElementChild);
                }
            }

            document.getElementById('prizeForm').onsubmit = async function (e) {
                e.preventDefault();
                const formData = new FormData(this);

                const packNames = [];
                const prices = [];
                document
                    .querySelectorAll('input[name="packName"]')
                    .forEach((input) => packNames.push(input.value));
                document
                    .querySelectorAll('input[name="price"]')
                    .forEach((input) => prices.push(input.value));

                // Get configuration values
                const config = {
                    storeProfitRate: parseFloat(document.getElementById('storeProfitRate').value) / 100,
                    toPayoutRate: parseFloat(document.getElementById('toPayoutRate').value) / 100,
                    storeCostFactor: parseFloat(document.getElementById('storeCostFactor').value) / 100,
                    salesTaxRate: parseFloat(document.getElementById('salesTaxRate').value) / 100
                };

                const data = {
                    numPlayers: formData.get('numPlayers'),
                    entryFee: formData.get('entryFee'),
                    withTO: formData.get('withTO') === 'on',
                    config: config,
                    packs: packNames.map((name, i) => ({
                        name,
                        price: prices[i],
                    })),
                };

                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                const result = await response.json();
                document.getElementById('result').innerHTML =
                    `<pre>${result.result}</pre>`;
            };
        </script>
    </body>
</html>
