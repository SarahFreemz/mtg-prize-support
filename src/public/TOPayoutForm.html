<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MTG Prize Support â€” TO Payout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body class="container-fluid bg-light">
    <div class="container px-2 px-sm-4 py-4" style="max-width: 600px; margin-top: 40px;">
      <div class="d-flex align-items-center mb-3">
        <a href="/" class="btn btn-sm btn-outline-secondary me-3">&larr; Home</a>
        <h3 class="mb-0 flex-grow-1 text-center">TO Payout Calculator</h3>
        <div style="width:86px;"></div>
      </div>

      <p class="text-center text-muted">
        Enter the names, prices, and quantities of event and prize packs. The amount to be paid to the event organizer will be calculated.
      </p>

      <!-- Configuration Section (unchanged) -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small class="text-muted">Configuration Settings</small>
          <button class="btn btn-link p-0 text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#configSection" aria-expanded="false" aria-controls="configSection" style="font-size: 14px;">
            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
              <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
            </svg>
          </button>
        </div>
        <div class="collapse" id="configSection">
          <div class="p-3 bg-white rounded border">
            <div class="row g-2 mb-3">
              <div class="col-6 col-md-6">
                <label for="storeProfitRate" class="form-label small text-muted">Store Profit Rate (%)</label>
                <input type="number" id="storeProfitRate" name="storeProfitRate" class="form-control form-control-sm" value="20" min="0" max="100" step="any" />
              </div>
              <div class="col-6 col-md-6">
                <label for="toPayoutRate" class="form-label small text-muted">TO Payout Rate (%)</label>
                <input type="number" id="toPayoutRate" name="toPayoutRate" class="form-control form-control-sm" value="20" min="0" max="100" step="any" />
              </div>
            </div>
            <div class="row g-2 mb-3">
              <div class="col-6 col-md-6">
                <label for="storeCostFactor" class="form-label small text-muted">Store Cost Factor (%)</label>
                <input type="number" id="storeCostFactor" name="storeCostFactor" class="form-control form-control-sm" value="60" min="0" max="100" step="any" />
              </div>
              <div class="col-6 col-md-6">
                <label for="salesTaxRate" class="form-label small text-muted">Sales Tax Rate (%)</label>
                <input type="number" id="salesTaxRate" name="salesTaxRate" class="form-control form-control-sm" value="6" min="0" max="100" step="any" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <form id="prizeForm">
        <div class="row g-2 mb-3">
          <div class="col-6 col-md-6">
            <label for="numPlayers" class="form-label">Number of Players</label>
            <input type="number" id="numPlayers" name="numPlayers" class="form-control" min="1" required />
          </div>
          <div class="col-6 col-md-6">
            <label for="entryFee" class="form-label">Entry Fee</label>
            <input type="number" id="entryFee" name="entryFee" class="form-control" min="0" step="any" required />
          </div>
        </div>

        <!-- Event Packs section -->
        <h5 class="small text-muted">Event Packs (per-player)</h5>
        <div id="eventEntries">
          <div class="event-entry-row row mb-2 g-1 align-items-center">
            <div class="col-5 col-md-5">
              <label class="form-label visually-hidden">Pack Name</label>
              <input type="text" name="eventPackName" class="form-control" placeholder="Name" />
            </div>
            <div class="col-4 col-md-4">
              <label class="form-label visually-hidden">Price/Pack</label>
              <input type="number" name="eventPrice" class="form-control" placeholder="Price" step="any" />
            </div>
            <div class="col-3 col-md-3">
              <label class="form-label visually-hidden">Qty/Player</label>
              <input type="number" name="eventQtyPerPlayer" class="form-control" placeholder="Qty/player" min="0" step="1" value="0" />
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 mb-3">
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addEventEntry()">Add Event Pack</button>
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLastEventEntry()">Remove Event Pack</button>
        </div>

        <hr />

        <!-- Prize Packs section -->
        <h5 class="small text-muted">Prize Packs (total quantity used)</h5>
        <div id="prizeEntries">
          <div class="prize-entry-row row mb-2 g-1 align-items-center">
            <div class="col-6 col-md-6">
              <label class="form-label visually-hidden">Pack Name</label>
              <input type="text" name="prizePackName" class="form-control" placeholder="Name" />
            </div>
            <div class="col-3 col-md-3">
              <label class="form-label visually-hidden">Price/Pack</label>
              <input type="number" name="prizePrice" class="form-control" placeholder="Price" step="any" />
            </div>
            <div class="col-3 col-md-3">
              <label class="form-label visually-hidden">Total Qty</label>
              <input type="number" name="prizeTotalQty" class="form-control" placeholder="Total qty" min="0" step="1" value="0" />
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 mb-3">
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addPrizeEntry()">Add Prize Pack</button>
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLastPrizeEntry()">Remove Prize Pack</button>
        </div>

        <!-- Moved and de-emphasized Additional costs (narrow input, responsive) -->
        <div class="row mb-3">
          <div class="col-12 d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between">
            <div>
              <label for="additionalCosts" class="form-label small text-muted mb-0">Additional costs (optional)</label>
              <div class="form-text small text-muted">Other event expenses to deduct from revenue (paid event kit, judge, etc.)</div>
            </div>
            <input type="number" id="additionalCosts" name="additionalCosts" class="form-control form-control-sm mt-2 mt-sm-0" value="0" min="0" step="any" style="max-width:140px;" />
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">Calculate TO Payout</button>
      </form>

      <div class="d-flex justify-content-end mt-2">
        <button id="printReceiptBtn" type="button" class="btn btn-outline-secondary btn-sm d-none">Print Receipt</button>
      </div>
      <div id="result" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Event pack functions
      function addEventEntry() {
        const div = document.createElement('div');
        div.className = 'event-entry-row row mb-2 g-1 align-items-center';
        div.innerHTML =
          '<div class="col-5 col-md-5">' +
            '<label class="form-label visually-hidden">Pack Name</label>' +
            '<input type="text" name="eventPackName" class="form-control" placeholder="Name">' +
          '</div>' +
          '<div class="col-4 col-md-4">' +
            '<label class="form-label visually-hidden">Price/Pack</label>' +
            '<input type="number" name="eventPrice" class="form-control" placeholder="Price" step="any">' +
          '</div>' +
          '<div class="col-3 col-md-3">' +
            '<label class="form-label visually-hidden">Qty/Player</label>' +
            '<input type="number" name="eventQtyPerPlayer" class="form-control" placeholder="Qty/player" min="0" step="1" value="0">' +
          '</div>';
        document.getElementById('eventEntries').appendChild(div);
      }

      function removeLastEventEntry() {
        const entries = document.getElementById('eventEntries');
        if (entries.children.length > 1) entries.removeChild(entries.lastElementChild);
      }

      // Prize pack functions
      function addPrizeEntry() {
        const div = document.createElement('div');
        div.className = 'prize-entry-row row mb-2 g-1 align-items-center';
        div.innerHTML =
          '<div class="col-6 col-md-6">' +
            '<label class="form-label visually-hidden">Pack Name</label>' +
            '<input type="text" name="prizePackName" class="form-control" placeholder="Name">' +
          '</div>' +
          '<div class="col-3 col-md-3">' +
            '<label class="form-label visually-hidden">Price/Pack</label>' +
            '<input type="number" name="prizePrice" class="form-control" placeholder="Price" step="any">' +
          '</div>' +
          '<div class="col-3 col-md-3">' +
            '<label class="form-label visually-hidden">Total Qty</label>' +
            '<input type="number" name="prizeTotalQty" class="form-control" placeholder="Total qty" min="0" step="1" value="0">' +
          '</div>';
        document.getElementById('prizeEntries').appendChild(div);
      }

      function removeLastPrizeEntry() {
        const entries = document.getElementById('prizeEntries');
        if (entries.children.length > 1) entries.removeChild(entries.lastElementChild);
      }

      // Utility to escape HTML when injecting server strings into the page
      function escapeHtml(str) {
        return String(str || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      // Submit handler
      document.getElementById('prizeForm').onsubmit = async function (e) {
        e.preventDefault();

        // Collect event packs
        const eventNames = Array.from(document.querySelectorAll('input[name="eventPackName"]')).map(i => i.value);
        const eventPrices = Array.from(document.querySelectorAll('input[name="eventPrice"]')).map(i => i.value);
        const eventQtys = Array.from(document.querySelectorAll('input[name="eventQtyPerPlayer"]')).map(i => i.value);

        const eventPacks = eventNames.map((name, idx) => ({
          name,
          price: eventPrices[idx],
          qtyPerPlayer: parseInt(eventQtys[idx], 10) || 0
        })).filter(p => p.name || parseFloat(p.price) > 0 || p.qtyPerPlayer > 0);

        // Collect prize packs
        const prizeNames = Array.from(document.querySelectorAll('input[name="prizePackName"]')).map(i => i.value);
        const prizePrices = Array.from(document.querySelectorAll('input[name="prizePrice"]')).map(i => i.value);
        const prizeQtys = Array.from(document.querySelectorAll('input[name="prizeTotalQty"]')).map(i => i.value);

        const prizePacks = prizeNames.map((name, idx) => ({
          name,
          price: prizePrices[idx],
          totalQty: parseInt(prizeQtys[idx], 10) || 0
        })).filter(p => p.name || parseFloat(p.price) > 0 || p.totalQty > 0);

        // Config values
        const config = {
          storeProfitRate: parseFloat(document.getElementById('storeProfitRate').value) / 100,
          toPayoutRate: parseFloat(document.getElementById('toPayoutRate').value) / 100,
          storeCostFactor: parseFloat(document.getElementById('storeCostFactor').value) / 100,
          salesTaxRate: parseFloat(document.getElementById('salesTaxRate').value) / 100
        };

        const formData = new FormData(this);

        const data = {
          numPlayers: parseInt(formData.get('numPlayers')),
          entryFee: parseFloat(formData.get('entryFee')),
          // request the server to calculate the TO payout for this mode
          withTO: true,
          config,
          eventPacks,
          prizePacks,
          additionalCosts: parseFloat(formData.get('additionalCosts')) || 0,
          // include prizePacks as 'packs' for backward compatibility
          packs: prizePacks,
          mode: 'to-payout'
        };

        try {
          const response = await fetch('/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          // Prioritize showing the calculated TO payout at the top
          var out = '<div class="alert alert-success">';
          if (result.totals && typeof result.totals.toPayout === 'number') {
            out += '<div><strong>Calculated TO payout:</strong> $' + result.totals.toPayout.toFixed(2) + '</div>';
          }


          // Note: packs-available table removed from TO payout view (kept on Prize Support page)

          // Fallback: include the server's human-readable summary in a collapsed pre block
          if (result.result) {
            out += '<details class="mt-2"><summary>Detailed summary</summary><pre style="white-space:pre-wrap;">' + escapeHtml(result.result) + '</pre></details>';
          }

          out += '</div>';
          document.getElementById('result').innerHTML = out;
          // store for shared printer
          window.__lastServerResult = result;
          if (window.ReceiptPrinter) {
            try { window.__lastReceiptText = ReceiptPrinter.buildReceiptText(result); } catch (e) { }
          }
          // reveal print button now that we have a result
          try { document.getElementById('printReceiptBtn').classList.remove('d-none'); } catch (e) {}
        } catch (error) {
          document.getElementById('result').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
      };
    </script>
    <script src="receipt-print.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        if (window.ReceiptPrinter) {
          ReceiptPrinter.attachPrintHandler('#printReceiptBtn', function () {
            return window.__lastReceiptText || (window.__lastServerResult ? ReceiptPrinter.buildReceiptText(window.__lastServerResult) : '');
          });
          if (window.__lastServerResult && !window.__lastReceiptText) {
            try { window.__lastReceiptText = ReceiptPrinter.buildReceiptText(window.__lastServerResult); } catch (e) {}
          }
        }
      });
    </script>
  </body>
</html>
